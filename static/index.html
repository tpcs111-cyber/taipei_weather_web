<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°åŒ—å¤©æ°£æŸ¥è©¢ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* å´é‚Šæ¬„æ¨£å¼ */
        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar h2 {
            color: #4a5568;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4ECDC4;
        }

        .sidebar-info {
            background: #e6f7ff;
            border-left: 4px solid #1890ff;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input[type="date"]:focus {
            outline: none;
            border-color: #4ECDC4;
        }

        .date-range-info {
            background: #f0fff4;
            border-left: 4px solid #38a169;
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .query-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4ECDC4 0%, #44a08d 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .query-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.4);
        }

        .query-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* ä¸»å…§å®¹å€åŸŸ */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
        }

        .content-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .content-card h2 {
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        /* è¨Šæ¯æ¨£å¼ */
        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .message.info {
            background: #e6f7ff;
            border-left: 4px solid #1890ff;
            color: #0050b3;
        }

        .message.success {
            background: #f0fff4;
            border-left: 4px solid #38a169;
            color: #22543d;
        }

        .message.error {
            background: #fff5f5;
            border-left: 4px solid #e53e3e;
            color: #c53030;
        }

        /* è¼‰å…¥ä¸­å‹•ç•« */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4ECDC4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* åœ–è¡¨å®¹å™¨ */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        /* è¡¨æ ¼æ¨£å¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #4ECDC4;
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        /* æ—¥æœŸæŒ‰éˆ• */
        .date-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .date-btn {
            flex: 1;
            min-width: 120px;
            padding: 15px 10px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .date-btn:hover {
            border-color: #4ECDC4;
            background: #f0fffd;
        }

        .date-btn.active {
            border-color: #4ECDC4;
            background: #4ECDC4;
            color: white;
        }

        .date-btn .date {
            font-weight: 600;
            font-size: 14px;
        }

        .date-btn .weekday {
            font-size: 12px;
            color: #718096;
            margin: 5px 0;
        }

        .date-btn.active .weekday {
            color: rgba(255, 255, 255, 0.8);
        }

        .date-btn .weather {
            font-size: 11px;
            color: #a0aec0;
        }

        .date-btn.active .weather {
            color: rgba(255, 255, 255, 0.9);
        }

        /* æ¯å°æ™‚è©³ç´°å€åŸŸ */
        .hourly-section {
            display: none;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid #eee;
        }

        .hourly-section.active {
            display: block;
        }

        /* ä¸‹è¼‰æŒ‰éˆ• */
        .download-btn {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            text-decoration: none;
        }

        .download-btn:hover {
            transform: translateY(-2px);
        }

        /* åˆå§‹èªªæ˜ */
        .instructions {
            line-height: 1.8;
        }

        .instructions h3 {
            color: #4a5568;
            margin: 20px 0 10px;
        }

        .instructions ul {
            margin-left: 25px;
        }

        .instructions li {
            margin: 8px 0;
        }

        /* é å°¾ */
        .footer {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
            }

            .date-btn {
                min-width: calc(50% - 10px);
            }

            .data-table {
                font-size: 12px;
            }

            .data-table th,
            .data-table td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å´é‚Šæ¬„ -->
        <aside class="sidebar">
            <h2>ğŸ“… é¸æ“‡æ—¥æœŸç¯„åœ</h2>

            <div class="sidebar-info">
                é¸æ“‡é–‹å§‹æ—¥æœŸå¾Œï¼ŒçµæŸæ—¥æœŸæœƒè‡ªå‹•è¨­å®šç‚º 7 å¤©å¾Œ
            </div>

            <div class="form-group">
                <label for="startDate">é–‹å§‹æ—¥æœŸ</label>
                <input type="date" id="startDate">
            </div>

            <div class="form-group">
                <label for="endDate">çµæŸæ—¥æœŸ</label>
                <input type="date" id="endDate">
            </div>

            <div class="date-range-info" id="dateRangeInfo">
                âœ… å·²é¸æ“‡ 7 å¤©çš„å¤©æ°£è³‡æ–™
            </div>

            <div class="form-group">
                <strong>é¸å®šæ—¥æœŸç¯„åœ</strong>
                <div class="sidebar-info" id="selectedRange" style="margin-top: 10px;">
                    --
                </div>
            </div>

            <button class="query-btn" id="queryBtn" onclick="fetchWeatherData()">
                ğŸ” æŸ¥è©¢å¤©æ°£
            </button>
        </aside>

        <!-- ä¸»å…§å®¹å€åŸŸ -->
        <main class="main-content">
            <div class="header">
                <h1>ğŸŒ¤ï¸ å°åŒ—å¤©æ°£æŸ¥è©¢ç³»çµ±</h1>
            </div>

            <!-- è¼‰å…¥ä¸­ -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨ç²å–å¤©æ°£è³‡æ–™...</p>
            </div>

            <!-- çµæœå€åŸŸ -->
            <div id="resultSection" style="display: none;">
                <div class="message success" id="successMessage"></div>

                <!-- æº«åº¦åœ–è¡¨ -->
                <div class="content-card">
                    <h2>ğŸ“ˆ æº«åº¦è®ŠåŒ–è¶¨å‹¢</h2>
                    <div class="chart-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>

                <!-- å¤©æ°£è³‡æ–™è¡¨æ ¼ -->
                <div class="content-card">
                    <h2>ğŸ“Š å¤©æ°£è³‡æ–™ç¸½è¦½</h2>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="weatherTable">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>æ˜ŸæœŸ</th>
                                    <th>å¤©æ°£ç‹€æ³</th>
                                    <th>é™é›¨æ©Ÿç‡(%)</th>
                                    <th>æœ€ä½æº«(Â°C)</th>
                                    <th>æœ€ä½æº«æ™‚é–“</th>
                                    <th>æœ€é«˜æº«(Â°C)</th>
                                    <th>æœ€é«˜æº«æ™‚é–“</th>
                                    <th>å¹³å‡æ¿•åº¦(%)</th>
                                    <th>æœ€å¤§é¢¨é€Ÿ(m/s)</th>
                                    <th>é¢¨å‘</th>
                                </tr>
                            </thead>
                            <tbody id="weatherTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- æ—¥æœŸé¸æ“‡æŒ‰éˆ• -->
                <div class="content-card">
                    <h2>ğŸ—“ï¸ é»æ“Šæ—¥æœŸæŸ¥çœ‹æ¯å°æ™‚è©³ç´°è³‡æ–™</h2>
                    <div class="date-buttons" id="dateButtons"></div>

                    <!-- æ¯å°æ™‚è©³ç´°è³‡æ–™ -->
                    <div class="hourly-section" id="hourlySection">
                        <h3 id="hourlyTitle">ğŸ• æ¯å°æ™‚è©³ç´°å¤©æ°£</h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="hourlyTempChart"></canvas>
                        </div>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="hourlyRainChart"></canvas>
                        </div>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="hourlyHumidityChart"></canvas>
                        </div>
                        <div style="overflow-x: auto; margin-top: 20px;">
                            <table class="data-table" id="hourlyTable">
                                <thead>
                                    <tr>
                                        <th>æ™‚é–“</th>
                                        <th>å¤©æ°£</th>
                                        <th>æº«åº¦(Â°C)</th>
                                        <th>é™é›¨æ©Ÿç‡(%)</th>
                                        <th>ç›¸å°æ¿•åº¦(%)</th>
                                        <th>é¢¨é€Ÿ(m/s)</th>
                                        <th>é¢¨å‘</th>
                                    </tr>
                                </thead>
                                <tbody id="hourlyTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ä¸‹è¼‰å€åŸŸ -->
                <div class="content-card">
                    <h2>ğŸ’¾ ä¸‹è¼‰è³‡æ–™</h2>
                    <button class="download-btn" onclick="downloadCSV()">
                        ğŸ“¥ ä¸‹è¼‰ CSV æª”æ¡ˆ
                    </button>
                </div>
            </div>

            <!-- åˆå§‹èªªæ˜ -->
            <div class="content-card" id="instructionsSection">
                <div class="message info">
                    ğŸ‘ˆ è«‹åœ¨å·¦å´é¸æ“‡æ—¥æœŸç¯„åœï¼Œç„¶å¾Œé»æ“Šã€ŒæŸ¥è©¢å¤©æ°£ã€æŒ‰éˆ•
                </div>

                <div class="instructions">
                    <h3>ä½¿ç”¨èªªæ˜</h3>
                    <ul>
                        <li>åœ¨å·¦å´é‚Šæ¬„é¸æ“‡ <strong>é–‹å§‹æ—¥æœŸ</strong>ï¼ŒçµæŸæ—¥æœŸæœƒè‡ªå‹•è¨­å®šç‚º 7 å¤©å¾Œ</li>
                        <li>å¯æ‰‹å‹•èª¿æ•´çµæŸæ—¥æœŸï¼ˆé™å®š 7 å¤©ä»¥å…§ï¼‰</li>
                        <li>é»æ“Š <strong>ã€ŒğŸ” æŸ¥è©¢å¤©æ°£ã€</strong> æŒ‰éˆ•</li>
                        <li>æŸ¥çœ‹æº«åº¦è®ŠåŒ–è¶¨å‹¢åœ–ï¼ˆæ¨™è¨»æœ€é«˜/æœ€ä½æº«æ™‚é–“å’Œå¤©æ°£ç‹€æ³ï¼‰</li>
                        <li>é»æ“Šä»»ä¸€æ—¥æœŸæŒ‰éˆ•ï¼ŒæŸ¥çœ‹è©²æ—¥æ¯å°æ™‚è©³ç´°å¤©æ°£è®ŠåŒ–</li>
                        <li>å¯ä¸‹è¼‰ CSV æª”æ¡ˆä¿å­˜è³‡æ–™</li>
                    </ul>

                    <h3>åŠŸèƒ½ç‰¹è‰²</h3>
                    <ul>
                        <li>ğŸ“… è‡ªå‹•è¨ˆç®— 7 å¤©æ—¥æœŸç¯„åœ</li>
                        <li>ğŸ“ˆ äº’å‹•å¼æº«åº¦è¶¨å‹¢åœ–</li>
                        <li>ğŸ• æ¯æ—¥æ¯å°æ™‚è©³ç´°è³‡æ–™å±•é–‹</li>
                        <li>ğŸ“Š å¤šç¶­åº¦å¤©æ°£è³‡æ–™è¦–è¦ºåŒ–</li>
                        <li>ğŸ”’ API Key å®‰å…¨å­˜æ”¾æ–¼å¾Œç«¯</li>
                    </ul>

                    <h3>è³‡æ–™ä¾†æº</h3>
                    <ul>
                        <li>ä¸­å¤®æ°£è±¡ç½²é–‹æ”¾è³‡æ–™å¹³å°</li>
                        <li>è³‡æ–™æ›´æ–°é »ç‡ï¼šå³æ™‚</li>
                    </ul>
                </div>
            </div>

            <div class="footer">
                å°åŒ—å¤©æ°£æŸ¥è©¢ç³»çµ± | è³‡æ–™ä¾†æºï¼šä¸­å¤®æ°£è±¡ç½² | FastAPI å¾Œç«¯ç‰ˆæœ¬
            </div>
        </main>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let weatherData = null;
        let hourlyData = null;
        let temperatureChart = null;
        let hourlyTempChart = null;
        let hourlyRainChart = null;
        let hourlyHumidityChart = null;

        // åˆå§‹åŒ–æ—¥æœŸ
        function initDates() {
            const today = new Date();
            const endDate = new Date(today);
            endDate.setDate(today.getDate() + 6);

            document.getElementById('startDate').value = formatDateForInput(today);
            document.getElementById('endDate').value = formatDateForInput(endDate);

            updateDateRangeInfo();
        }

        // æ ¼å¼åŒ–æ—¥æœŸç‚º input æ ¼å¼
        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        // æ ¼å¼åŒ–æ—¥æœŸç‚ºé¡¯ç¤ºæ ¼å¼
        function formatDateForDisplay(dateStr) {
            const date = new Date(dateStr);
            return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
        }

        // æ›´æ–°æ—¥æœŸç¯„åœè³‡è¨Š
        function updateDateRangeInfo() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            const diffDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

            document.getElementById('dateRangeInfo').textContent = `âœ… å·²é¸æ“‡ ${diffDays} å¤©çš„å¤©æ°£è³‡æ–™`;
            document.getElementById('selectedRange').textContent =
                `${formatDateForDisplay(startDate)} è‡³ ${formatDateForDisplay(endDate)}`;
        }

        // é–‹å§‹æ—¥æœŸæ”¹è®Šæ™‚è‡ªå‹•è¨­å®šçµæŸæ—¥æœŸ
        document.getElementById('startDate').addEventListener('change', function() {
            const startDate = new Date(this.value);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            document.getElementById('endDate').value = formatDateForInput(endDate);
            document.getElementById('endDate').min = this.value;
            document.getElementById('endDate').max = formatDateForInput(endDate);
            updateDateRangeInfo();
        });

        document.getElementById('endDate').addEventListener('change', updateDateRangeInfo);

        // ç²å–å¤©æ°£è³‡æ–™ï¼ˆå¾å¾Œç«¯ APIï¼‰
        async function fetchWeatherData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            document.getElementById('loading').classList.add('active');
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('instructionsSection').style.display = 'none';
            document.getElementById('queryBtn').disabled = true;

            try {
                // å‘¼å«å¾Œç«¯ APIï¼ˆä¸éœ€è¦å‚³ API Keyï¼Œå¾Œç«¯æœƒè™•ç†ï¼‰
                const response = await fetch(`/api/weather?start_date=${startDate}&end_date=${endDate}`);
                const data = await response.json();

                if (response.ok && data.success) {
                    weatherData = data.daily;
                    hourlyData = data.hourly;
                    displayResults(startDate, endDate);
                } else {
                    throw new Error(data.detail || 'API å›å‚³å¤±æ•—');
                }
            } catch (error) {
                console.error('éŒ¯èª¤:', error);
                alert('ç²å–å¤©æ°£è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                document.getElementById('instructionsSection').style.display = 'block';
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('queryBtn').disabled = false;
            }
        }

        // é¡¯ç¤ºçµæœ
        function displayResults(startDate, endDate) {
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('successMessage').textContent =
                `âœ… æˆåŠŸç²å– ${formatDateForDisplay(startDate)} è‡³ ${formatDateForDisplay(endDate)} çš„å¤©æ°£è³‡æ–™`;

            drawTemperatureChart();
            fillWeatherTable();
            createDateButtons();
        }

        // ç¹ªè£½æº«åº¦æ›²ç·šåœ–
        function drawTemperatureChart() {
            const ctx = document.getElementById('temperatureChart').getContext('2d');

            if (temperatureChart) {
                temperatureChart.destroy();
            }

            const labels = weatherData.map(d => d.date);
            const maxTemps = weatherData.map(d => d.max_temp);
            const minTemps = weatherData.map(d => d.min_temp);

            temperatureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æœ€é«˜æº«',
                            data: maxTemps,
                            borderColor: '#FF6B6B',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: '#FF6B6B',
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'æœ€ä½æº«',
                            data: minTemps,
                            borderColor: '#4ECDC4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: '#4ECDC4',
                            tension: 0.3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const idx = context.dataIndex;
                                    const day = weatherData[idx];
                                    if (context.dataset.label === 'æœ€é«˜æº«') {
                                        return day.max_temp_time ? `æ™‚é–“: ${day.max_temp_time}` : '';
                                    } else {
                                        return day.min_temp_time ? `æ™‚é–“: ${day.min_temp_time}` : '';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'æº«åº¦ (Â°C)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        }
                    }
                }
            });
        }

        // å¡«å……å¤©æ°£è¡¨æ ¼
        function fillWeatherTable() {
            const tbody = document.getElementById('weatherTableBody');
            tbody.innerHTML = '';

            weatherData.forEach(day => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${day.date}</td>
                    <td>${day.weekday}</td>
                    <td>${day.weather || 'ç„¡è³‡æ–™'}</td>
                    <td>${day.rain_prob}</td>
                    <td>${day.min_temp !== null ? day.min_temp : 'ç„¡è³‡æ–™'}</td>
                    <td>${day.min_temp_time || '-'}</td>
                    <td>${day.max_temp !== null ? day.max_temp : 'ç„¡è³‡æ–™'}</td>
                    <td>${day.max_temp_time || '-'}</td>
                    <td>${day.avg_humidity !== null ? day.avg_humidity : 'ç„¡è³‡æ–™'}</td>
                    <td>${day.max_wind !== null ? day.max_wind : 'ç„¡è³‡æ–™'}</td>
                    <td>${day.wind_dir || 'ç„¡è³‡æ–™'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // å»ºç«‹æ—¥æœŸæŒ‰éˆ•
        function createDateButtons() {
            const container = document.getElementById('dateButtons');
            container.innerHTML = '';

            weatherData.forEach((day, idx) => {
                const btn = document.createElement('button');
                btn.className = 'date-btn';
                btn.innerHTML = `
                    <div class="date">${day.date}</div>
                    <div class="weekday">${day.weekday}</div>
                    <div class="weather">${day.weather || ''}</div>
                `;
                btn.onclick = () => showHourlyData(day.date, idx);
                container.appendChild(btn);
            });
        }

        // é¡¯ç¤ºæ¯å°æ™‚è³‡æ–™
        function showHourlyData(dateKey, btnIdx) {
            document.querySelectorAll('.date-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', idx === btnIdx);
            });

            const section = document.getElementById('hourlySection');
            section.classList.add('active');
            document.getElementById('hourlyTitle').textContent = `ğŸ• ${dateKey} æ¯å°æ™‚è©³ç´°å¤©æ°£`;

            const dayData = hourlyData[dateKey];
            if (!dayData) {
                section.innerHTML = '<p>æ²’æœ‰è©²æ—¥æœŸçš„æ¯å°æ™‚è³‡æ–™</p>';
                return;
            }

            const hours = Object.keys(dayData).sort();
            const temps = hours.map(h => dayData[h].temp);
            const rains = hours.map(h => dayData[h].rain);
            const humidities = hours.map(h => dayData[h].humidity);

            drawHourlyTempChart(hours, temps);
            drawHourlyRainChart(hours, rains);
            drawHourlyHumidityChart(hours, humidities);

            const tbody = document.getElementById('hourlyTableBody');
            tbody.innerHTML = '';

            hours.forEach(hour => {
                const data = dayData[hour];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${hour}</td>
                    <td>${data.weather || 'ç„¡è³‡æ–™'}</td>
                    <td>${data.temp !== null ? data.temp : 'ç„¡è³‡æ–™'}</td>
                    <td>${data.rain !== null ? data.rain : 'ç„¡è³‡æ–™'}</td>
                    <td>${data.humidity !== null ? data.humidity : 'ç„¡è³‡æ–™'}</td>
                    <td>${data.wind_speed !== null ? data.wind_speed.toFixed(1) : 'ç„¡è³‡æ–™'}</td>
                    <td>${data.wind_dir || 'ç„¡è³‡æ–™'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ç¹ªè£½æ¯å°æ™‚æº«åº¦åœ–
        function drawHourlyTempChart(hours, temps) {
            const ctx = document.getElementById('hourlyTempChart').getContext('2d');
            if (hourlyTempChart) hourlyTempChart.destroy();

            hourlyTempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'æº«åº¦ (Â°C)',
                        data: temps,
                        borderColor: '#FF6B6B',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        borderWidth: 2,
                        pointRadius: 4,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { title: { display: true, text: 'æº«åº¦ (Â°C)' } },
                        x: { title: { display: true, text: 'æ™‚é–“' } }
                    }
                }
            });
        }

        // ç¹ªè£½æ¯å°æ™‚é™é›¨æ©Ÿç‡åœ–
        function drawHourlyRainChart(hours, rains) {
            const ctx = document.getElementById('hourlyRainChart').getContext('2d');
            if (hourlyRainChart) hourlyRainChart.destroy();

            hourlyRainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'é™é›¨æ©Ÿç‡ (%)',
                        data: rains,
                        borderColor: '#4ECDC4',
                        backgroundColor: 'rgba(78, 205, 196, 0.3)',
                        borderWidth: 2,
                        pointRadius: 4,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { title: { display: true, text: 'é™é›¨æ©Ÿç‡ (%)' }, min: 0, max: 100 },
                        x: { title: { display: true, text: 'æ™‚é–“' } }
                    }
                }
            });
        }

        // ç¹ªè£½æ¯å°æ™‚æ¿•åº¦åœ–
        function drawHourlyHumidityChart(hours, humidities) {
            const ctx = document.getElementById('hourlyHumidityChart').getContext('2d');
            if (hourlyHumidityChart) hourlyHumidityChart.destroy();

            hourlyHumidityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'ç›¸å°æ¿•åº¦ (%)',
                        data: humidities,
                        borderColor: '#95E1D3',
                        backgroundColor: 'rgba(149, 225, 211, 0.3)',
                        borderWidth: 2,
                        pointRadius: 4,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { title: { display: true, text: 'ç›¸å°æ¿•åº¦ (%)' }, min: 0, max: 100 },
                        x: { title: { display: true, text: 'æ™‚é–“' } }
                    }
                }
            });
        }

        // ä¸‹è¼‰ CSV
        function downloadCSV() {
            if (!weatherData) return;

            const headers = ['æ—¥æœŸ', 'æ˜ŸæœŸ', 'å¤©æ°£ç‹€æ³', 'é™é›¨æ©Ÿç‡(%)', 'æœ€ä½æº«åº¦(Â°C)', 'æœ€ä½æº«æ™‚é–“', 'æœ€é«˜æº«åº¦(Â°C)', 'æœ€é«˜æº«æ™‚é–“', 'å¹³å‡æ¿•åº¦(%)', 'æœ€å¤§é¢¨é€Ÿ(m/s)', 'é¢¨å‘'];
            const rows = weatherData.map(day => [
                day.date,
                day.weekday,
                day.weather || '',
                day.rain_prob,
                day.min_temp !== null ? day.min_temp : '',
                day.min_temp_time || '',
                day.max_temp !== null ? day.max_temp : '',
                day.max_temp_time || '',
                day.avg_humidity !== null ? day.avg_humidity : '',
                day.max_wind !== null ? day.max_wind : '',
                day.wind_dir || ''
            ]);

            let csvContent = '\uFEFF' + headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const startDate = document.getElementById('startDate').value.replace(/-/g, '');
            const endDate = document.getElementById('endDate').value.replace(/-/g, '');

            link.href = URL.createObjectURL(blob);
            link.download = `å°åŒ—å¤©æ°£_${startDate}_${endDate}.csv`;
            link.click();
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initDates);
    </script>
</body>
</html>
